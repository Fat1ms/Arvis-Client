# Руководство по Kaldi wake word для Arvis

Данное руководство описывает использование Kaldi (через библиотеку Vosk) в качестве детектора ключевой фразы. Здесь вы найдёте рекомендации по настройке конфигурации, подготовке словарей для русского и украинского языков и тестированию качества распознавания.

## 1. Требования и установка

1. Убедитесь, что зависимости установлены:

   ```powershell
   pip install -r requirements.txt
   ```

   В списке уже присутствуют `vosk`, `pyaudio`, `numpy` — дополнительных пакетов для Kaldi-детектора не требуется.
2. Загрузите подходящую offline-модель Vosk (основанную на Kaldi). Рекомендуемые варианты:
   - Русский язык: [vosk-model-ru-0.42](https://alphacephei.com/vosk/models)
   - Украинский язык: [vosk-model-uk-v3-small](https://alphacephei.com/vosk/models)
   Распакуйте модель в каталог `models/` и укажите путь в `config/config.json` → `stt.kaldi_model_path`.

## 2. Базовая конфигурация

Раздел `stt` в `config/config.json`:

```json
"stt": {
  "engine": "vosk",
  "model_path": "D:/AI/Arvis/models/vosk-model-ru-0.42",
  "wake_word": "Арвис",
  "wake_word_engine": "kaldi",
  "kaldi_model_path": "D:/AI/Arvis/models/vosk-model-ru-0.42",
  "kaldi_wake_words": [
    "арвис",
    "арвіс"
  ],
  "kaldi_sample_rate": 16000,
  "kaldi_chunk_size": 2048,
  "kaldi_cooldown": 1.0
}
```

- `kaldi_wake_words` — список вариантов написания/произношения (в нижнем регистре). Добавляйте формы «арвис», «эй, арвис», «арвіс», чтобы охватить русский и украинский варианты.
- `kaldi_sample_rate` и `kaldi_chunk_size` обычно совпадают с параметрами модели (16 кГц и ~2000 сэмплов на буфер).
- `kaldi_cooldown` задаёт задержку между повторными срабатываниями, чтобы избежать дребезга.

Изменения вступают в силу после перезапуска Arvis или повторной загрузки настроек.

## 3. Подготовка словарей и произношений

Kaldi (Vosk) использует словарь фонем для распознавания. Большинство моделей уже включают базовые русские и украинские слова. Если ключевой фразы нет в словаре, можно добавить её:

1. Найдите файл словаря в папке модели: обычно `model\graph\phones\word_boundary.int` и `model\graph\phones.txt`. Для пользовательских слов проще использовать `vosk-recasepunc` или готовые словари.
2. Для небольших кастомизаций создайте отдельный файл `custom.dict` с фонемным описанием. Пример для русского/украинского (с использованием кириллицы, Vosk понимает буквенное написание):

   ```
   арвис ar v is
   арвіс ar v is
   ````

   Сохраните файл в каталоге модели и запустите `vosk-model` с опцией `--augment` (подробнее в официальной документации Vosk).
3. Альтернативный путь — использовать `phonetisaurus` или `g2p-seq2seq` для генерации фонем и добавить их в словарь модели. После обновления словаря пересоберите FST (при необходимости) согласно инструкции Vosk/Kaldi.

Для большинства бытовых сценариев достаточно перечислить текстовые варианты в `kaldi_wake_words` — Vosk самостоятельно приведёт их к подходящим фонемам.

## 4. Сбор и анализ аудиоданных

Чтобы повысить точность, запишите несколько образцов ключевого слова:

1. Используйте встроенный в Arvis модуль записи (кнопка микрофона) или внешнюю программу.
2. Сохраните файлы WAV (`16kHz`, `mono`, `16-bit`).
3. Проверьте распознавание командой:

   ```powershell
   python tests\debug_test.py --transcribe path\to\sample.wav
   ```

   Убедитесь, что в выводе появляется «арвис»/«арвіс». Если в выводе `<unk>`, добавьте вариант в `kaldi_wake_words` или расширьте словарь.

## 5. Тонкая настройка

- **Варианты ключевой фразы.** Перечисляйте все допустимые фразы (включая короткие обращения «эй, арвис», «арвис включайся»). Детектор ищет подстроки, поэтому записи вроде «привет арвис» тоже сработают.
- **Уровень шума.** Если возникают ложные срабатывания, увеличьте `kaldi_chunk_size` (например, до 4096) и `kaldi_cooldown` (1.5–2.0). Это снизит чувствительность.
- **Двухъязычность.** Для украинского языка можно подключить отдельную модель (`kaldi_model_path` на UA модель) и задать соответствующий список слов. Если нужен автоматический выбор модели, переключайте `kaldi_model_path` и `kaldi_wake_words` в зависимости от текущего языка приложения.

## 6. Тестирование в реальном времени

Используйте режим отладки Vosk, чтобы смотреть частичные результаты:

```powershell
python -m vosk "D:/AI/Arvis/models/vosk-model-ru-0.42" --sample-rate 16000
```

Произнесите wake word и проверьте, что в потоке выводится нужная фраза. Аналогично можно воспользоваться сценарием `tests\multiple_requests_test.py`, чтобы проверить стабильность прослушивания.

## 7. Чек-лист

- [ ] Установлены зависимости (`vosk`, `pyaudio`, `numpy`).
- [ ] Скачана и подключена модель Vosk с поддержкой нужных языков.
- [ ] Обновлён `config/config.json` (`wake_word_engine = "kaldi"`, заполнены варианты `kaldi_wake_words`).
- [ ] Проведено тестирование на записанных образцах.
- [ ] Настроены параметры `kaldi_chunk_size` и `kaldi_cooldown` под рабочее окружение.

После выполнения этих шагов Arvis будет использовать Kaldi/Vosk детектор вместо Mycroft Precise, сохраняя единый стек для распознавания речи и wake word.
